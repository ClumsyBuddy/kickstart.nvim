
#f45873b3-b655-43a6-b217-97c00aa0db58 powertoys commandnotfound module

# import-module -name microsoft.winget.commandnotfound
#f45873b3-b655-43a6-b217-97c00aa0db58
# Lazy-load WinGet CommandNotFound only when needed
$script:WingetCNFLoaded = $false
$ExecutionContext.InvokeCommand.CommandNotFoundAction = {
  param($Name, $Args)

  if (-not $script:WingetCNFLoaded) {
    $script:WingetCNFLoaded = $true
    Import-Module -Name microsoft.winget.commandnotfound -ErrorAction SilentlyContinue | Out-Null
  }

  # Re-throw the original "not found" so the module can handle it via its hook
  throw [System.Management.Automation.CommandNotFoundException]::new($Name)
}


function activate-venv {
    if (test-path ".venv/scripts/activate.ps1") {
        & ".venv/scripts/activate.ps1"
        write-host "virtual environment activated!" -foregroundcolor green
    } elseif (test-path ".venv/scripts/activate.ps1") {
        & ".venv/scripts/activate.ps1"
        write-host "virtual environment activated!" -foregroundcolor green
    } else {
        write-host "no virtual environment found in current directory" -foregroundcolor red
    }
}



function open-rel {
<#
.synopsis
opens a folder in file explorer or visual studio code, resolving relative paths from the current directory.

.description
this function takes a relative path (with or without a trailing slash) and opens it in file explorer by default.
optionally, it can open the folder in visual studio code if the -vscode switch is provided.

.parameter relativepath
the relative path to the folder you want to open.

.parameter vscode
switch to open the folder in visual studio code instead of file explorer.

.example
open-rel 'late fees on deferred payments'
opens the folder in file explorer.

.example
open-rel 'late fees on deferred payments' -vscode
opens the folder in visual studio code.
#>

    param(
        [string]$relativepath,
        [switch]$code
    )

    # remove trailing backslash or slash if present
    $cleanpath = $relativepath.trimend('\', '/')

    # resolve the full path
    $fullpath = resolve-path $cleanpath -erroraction stop

    if ($code) {
        # open the folder in visual studio code
        code $fullpath
    } else {
        # open the folder in file explorer
        explorer $fullpath
    }
}


function rwsl {
    param(
        [parameter(valuefromremainingarguments=$true)]
        [string[]]$args
    )

    $winpath = (get-location).path
    $wslpath = $winpath -replace '^([a-za-z]):', '/mnt/$1' -replace '\\', '/'
    $wslpath = $wslpath.tolower()

    $command = ($args -join ' ')
    $fullcmd = "cd '$wslpath' && $command"

    wsl bash -lc "$fullcmd"
}

function open-currentpathinnewtab {
    # opens a new tab in the current window (-w 0) in the current directory (.)
    wt -w 0 nt -d .
}


# zoxide (buffer all lines, then invoke once)
if (Get-Command zoxide -ErrorAction SilentlyContinue) {
    $zoxideInit = (zoxide init powershell) -join "`n"
    if (-not [string]::IsNullOrWhiteSpace($zoxideInit)) {
        Invoke-Expression $zoxideInit
    }
}


# Lazy-init starship on first prompt render (no background job)
function global:prompt {
    if (-not $script:StarshipInited) {
        $script:StarshipInited = $true

        $current = $MyInvocation.MyCommand.ScriptBlock
        $init = & starship init powershell

        if ($init) { Invoke-Expression ($init -join "`n") }

        # If starship replaced prompt, call the new prompt immediately
        $new = (Get-Command prompt -CommandType Function).ScriptBlock
        if ($new -ne $current) { return & $new }
    }

    # Fallback if starship isn't available or init failed
    "PS $((Get-Location).Path)> "
}


function cht {
    # Join all arguments with a '+' sign
    $query = $args -join '+'
    # Use curl.exe (not PowerShell's 'curl' alias) to preserve ANSI colors
    curl.exe "cht.sh/$query"
}

function ai {
    $query = $args -join ' '
    copilot -p "$query"
}


# invoke-expression (&starship init powershell)
# # invoke-expression (& { (zoxide init powershell | out-string) })




set-alias -name finds -value findstr
# sets 'nt' as the shortcut for the function above
set-alias -name nt -value open-currentpathinnewtab
